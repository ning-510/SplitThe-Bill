<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ning & Hsiang çµ‚æ¥µè¨˜å¸³ V4 (è¨ºæ–·ç‰ˆ)</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --green: #10b981;
            --yellow: #f59e0b;
            --red: #ef4444;
            --border: #e5e7eb;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0; padding: 15px;
            max-width: 600px; margin: 0 auto;
            padding-bottom: 100px;
        }

        /* é ‚éƒ¨åŠŸèƒ½åˆ‡æ› */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn {
            flex: 1; padding: 10px; border: none; border-radius: 10px;
            font-weight: bold; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            background: #e5e7eb; color: #6b7280;
        }
        .tab-btn.active { background: var(--primary); color: white; }

        /* å¡ç‰‡å…±ç”¨æ¨£å¼ */
        .card {
            background: var(--card); border-radius: 16px; padding: 15px;
            margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* API è¨­å®šå€ */
        #api-settings { display: none; margin-bottom: 15px; background: #fff; padding: 15px; border-radius: 12px; border: 2px solid #fed7aa; }
        
        /* ğŸ“¸ AI ä¸Šå‚³å€ */
        .upload-area {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 120px;
            border: 2px dashed #cbd5e1; border-radius: 12px; background: #f8fafc;
            color: #64748b; cursor: pointer; box-sizing: border-box; transition: all 0.2s;
        }
        .upload-area:active { border-color: var(--primary); background: var(--primary-light); }
        #img-preview-box { display: none; margin-top: 10px; text-align: center; }
        #img-preview { max-width: 100%; max-height: 200px; border-radius: 8px; }

        /* ğŸ–ï¸ æ‰‹å‹•è¼¸å…¥å€ */
        .manual-grid { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .cat-chip {
            padding: 6px 12px; border-radius: 20px; font-size: 13px; background: #f3f4f6; border: 1px solid #e5e7eb; cursor: pointer; display: flex; align-items: center; gap: 4px;
        }
        .cat-chip.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary); font-weight: bold; }
        
        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        input, select {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            box-sizing: border-box; font-size: 16px; background: #fff; outline: none;
        }
        input:focus { border-color: var(--primary); }

        /* å‹•ä½œæŒ‰éˆ• */
        .btn-action {
            width: 100%; padding: 12px; border: none; border-radius: 10px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-primary:disabled { background: #93c5fd; cursor: not-allowed; }

        /* æ¸…å–®èˆ‡çµç®— */
        .list-container { margin-top: 20px; }
        .item-card {
            background: white; padding: 12px; border-radius: 12px; border-bottom: 1px solid #f3f4f6;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .item-left { display: flex; flex-direction: column; }
        .item-title { font-weight: 600; font-size: 15px; }
        .item-sub { font-size: 12px; color: #6b7280; }
        .item-price { font-weight: bold; font-size: 16px; }

        /* åº•éƒ¨å›ºå®šçµç®— */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(5px);
            border-top: 1px solid #e5e7eb; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 99;
        }
        .total-info { font-size: 13px; color: #4b5563; }
        .final-settle { font-weight: bold; font-size: 15px; color: var(--text); }

        /* è¼‰å…¥å‹•ç•« */
        .spinner { width: 18px; height: 18px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* éŒ¯èª¤æç¤º */
        #ai-error { 
            color: #7f1d1d; font-size: 12px; margin-top: 8px; display: none; 
            background: #fecaca; padding: 10px; border-radius: 6px; 
            word-break: break-all; white-space: pre-wrap; font-family: monospace;
        }
        
        .label { font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block; font-weight: 600; }
        .test-btn { background: #4b5563; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-top: 5px;}
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3>Ning & Hsiang è¨˜å¸³ V4</h3>
        <button onclick="toggleSettings()" style="background:none; border:none; color:#6b7280; font-size:12px; text-decoration:underline; cursor:pointer;">è¨­å®š & è¨ºæ–·</button>
    </div>

    <!-- API è¨­å®šå€ -->
    <div id="api-settings">
        <span class="label">Gemini API Key:</span>
        <input type="password" id="api-key-input" placeholder="è²¼ä¸Š AIza é–‹é ­çš„ Key">
        
        <span class="label" style="margin-top:10px;">AI æ¨¡å‹é¸æ“‡:</span>
        <select id="model-select" style="margin-bottom:5px;" onchange="checkCustomModel()">
            <option value="gemini-1.5-flash" selected>Gemini 1.5 Flash (é è¨­)</option>
            <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash Latest</option>
            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
            <option value="custom">âœï¸ è‡ªå®šç¾©æ¨¡å‹åç¨±...</option>
        </select>
        
        <input type="text" id="custom-model-input" placeholder="ä¾‹å¦‚: gemini-1.5-flash-001" style="display:none; margin-bottom:10px;">

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="testConnection()" class="test-btn" style="flex:1;">ğŸ”§ æ¸¬è©¦ç´”æ–‡å­—é€£ç·š</button>
            <button onclick="saveKey()" style="flex:2; padding:8px; background:#333; color:white; border:none; border-radius:6px; cursor:pointer;">å„²å­˜è¨­å®š</button>
        </div>
        <div id="test-result" style="font-size:11px; margin-top:8px; color:#666;"></div>
    </div>

    <!-- æ¨¡å¼åˆ‡æ› -->
    <div class="tabs">
        <button class="tab-btn active" id="tab-ai" onclick="switchTab('ai')">
            <i class="ph ph-camera"></i> AI è¾¨è­˜
        </button>
        <button class="tab-btn" id="tab-manual" onclick="switchTab('manual')">
            <i class="ph ph-keyboard"></i> æ‰‹å‹•è¼¸å…¥
        </button>
    </div>

    <!-- ğŸ“¸ AI æ¨¡å¼ -->
    <div id="view-ai" class="card">
        <label class="upload-area">
            <i class="ph ph-camera-plus" style="font-size:32px; color:#9ca3af; margin-bottom:5px;"></i>
            <div style="font-size:14px; color:#6b7280;">é»æ­¤æ‹æ”¶æ“š / é¸ç…§ç‰‡</div>
            <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(this)">
        </label>
        
        <div id="img-preview-box">
            <img id="img-preview">
        </div>

        <div id="ai-error"></div>

        <button id="scan-btn" class="btn-action btn-primary" onclick="processImage()" style="margin-top:10px; display:none;">
            <span id="scan-text">ğŸš€ é–‹å§‹è¾¨è­˜</span>
        </button>
        
        <div style="text-align:center; margin-top:10px; font-size:12px; color:#9ca3af;">
            å¦‚æœ AI å¤±æ•—ï¼Œè«‹æŒ‰ä¸Šæ–¹åˆ‡æ›åˆ°ã€Œæ‰‹å‹•è¼¸å…¥ã€
        </div>
    </div>

    <!-- ğŸ–ï¸ æ‰‹å‹•æ¨¡å¼ -->
    <div id="view-manual" class="card" style="display:none;">
        <div class="manual-grid" id="cat-chips"></div>
        <div class="input-row">
            <input type="text" id="m-name" placeholder="å“é …åç¨±" style="flex:2">
            <input type="number" id="m-price" placeholder="$" style="flex:1">
        </div>
        <div class="input-row">
            <select id="m-split" style="width:100%">
                <option value="his_pay_split">Hsiang / 2 (ä»–ä»˜å¹³åˆ†)</option>
                <option value="his_pay_for_me">Hsiang å¢Š (ç®—å¦³çš„)</option>
                <option value="his_pay_his_use">Hsiang (ä»–è‡ªå·±ç”¨)</option>
                <option value="my_pay_split" selected>Ning / 2 (å¦³ä»˜å¹³åˆ†)</option>
                <option value="my_pay_for_him">Ning å¢Š (ç®—ä»–çš„)</option>
                <option value="my_pay_my_use">Ning (å¦³è‡ªå·±ç”¨)</option>
            </select>
        </div>
        <button class="btn-action btn-primary" onclick="manualAdd()">
            <i class="ph ph-plus"></i> åŠ å…¥æ¸…å–®
        </button>
    </div>

    <!-- ğŸ“ æ¸…å–®åˆ—è¡¨ -->
    <div class="list-container" id="items-container"></div>

    <!-- åº•éƒ¨çµç®— -->
    <div class="bottom-bar">
        <div>
            <div class="total-info">ç¸½è¨ˆ <span id="sum-total" style="font-weight:bold; color:#000;">$0</span></div>
            <div class="final-settle" id="final-settle">äº’ä¸ç›¸æ¬ </div>
        </div>
        <button class="btn-action btn-green" onclick="copyResult()" style="width:auto; padding:8px 16px; font-size:14px;">
            <i class="ph ph-copy"></i> è¤‡è£½
        </button>
    </div>

<script>
    // --- è³‡æ–™è¨­å®š ---
    const CATEGORIES = ["é£²é£Ÿ", "å±…ä½", "8510", "äº¤é€š", "å¨›æ¨‚", "é†«ç™‚", "é›œæ”¯", "æ—…éŠ", "å¸•å¸ƒ", "å…¶ä»–"];
    const SPLIT_MAP = {
        "his_pay_split": "Hsiang / 2", "his_pay_for_me": "Hsiang å¢Š", "his_pay_his_use": "Hsiang",
        "my_pay_split": "Ning / 2", "my_pay_for_him": "Ning å¢Š", "my_pay_my_use": "Ning"
    };

    let items = [];
    let currentManualCat = "é£²é£Ÿ";

    // --- åˆå§‹åŒ– ---
    window.onload = () => {
        const key = localStorage.getItem("gemini_key_v2");
        const model = localStorage.getItem("gemini_model_v2") || "gemini-1.5-flash";
        
        if(key) document.getElementById("api-key-input").value = key;
        else document.getElementById("api-settings").style.display = "block";

        const select = document.getElementById("model-select");
        const options = Array.from(select.options).map(o => o.value);
        if (options.includes(model)) select.value = model;
        else { select.value = "custom"; document.getElementById("custom-model-input").style.display = "block"; document.getElementById("custom-model-input").value = model; }

        renderCatChips();
        const saved = localStorage.getItem("nh_items");
        if(saved) { items = JSON.parse(saved); renderList(); }
    };

    function toggleSettings() {
        const el = document.getElementById("api-settings");
        el.style.display = el.style.display === "none" ? "block" : "none";
    }

    function checkCustomModel() {
        const val = document.getElementById("model-select").value;
        const input = document.getElementById("custom-model-input");
        input.style.display = val === "custom" ? "block" : "none";
        if(val === "custom") input.focus();
    }

    function getKeyAndModel() {
        const key = document.getElementById("api-key-input").value.trim();
        let model = document.getElementById("model-select").value;
        if (model === "custom") model = document.getElementById("custom-model-input").value.trim();
        return { key, model };
    }

    function saveKey() {
        const { key, model } = getKeyAndModel();
        if(!key) return alert("è«‹è¼¸å…¥ Key");
        localStorage.setItem("gemini_key_v2", key);
        localStorage.setItem("gemini_model_v2", model);
        alert(`è¨­å®šå·²å„²å­˜ï¼\næ¨¡å‹: ${model}`);
        document.getElementById("api-settings").style.display = "none";
    }

    // --- è¨ºæ–·åŠŸèƒ½ ---
    async function testConnection() {
        const { key, model } = getKeyAndModel();
        const resDiv = document.getElementById("test-result");
        if(!key) return alert("è«‹å…ˆè¼¸å…¥ Key");
        
        resDiv.innerHTML = `<span class="spinner" style="display:inline-block; border-color:#666; width:10px; height:10px;"></span> æ¸¬è©¦ä¸­...`;
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
            });
            const data = await res.json();
            if(data.error) {
                resDiv.innerHTML = `<span style="color:red">âŒ å¤±æ•—: ${data.error.message}</span>`;
            } else if(data.candidates) {
                resDiv.innerHTML = `<span style="color:green">âœ… æˆåŠŸï¼API æš¢é€šï¼Œæ¨¡å‹å¯ç”¨ã€‚</span>`;
            } else {
                resDiv.innerHTML = `<span style="color:orange">âš ï¸ æ€ªæ€ªçš„: ${JSON.stringify(data)}</span>`;
            }
        } catch(e) {
            resDiv.innerHTML = `<span style="color:red">âŒ ç¶²è·¯éŒ¯èª¤: ${e.message}</span>`;
        }
    }

    function switchTab(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${mode}`).classList.add('active');
        document.getElementById('view-ai').style.display = mode === 'ai' ? 'block' : 'none';
        document.getElementById('view-manual').style.display = mode === 'manual' ? 'block' : 'none';
    }

    function renderCatChips() {
        document.getElementById("cat-chips").innerHTML = CATEGORIES.map(c => 
            `<div class="cat-chip ${c === currentManualCat ? 'active' : ''}" onclick="setManualCat('${c}')">${c}</div>`
        ).join("");
    }

    function setManualCat(cat) {
        currentManualCat = cat;
        renderCatChips();
        document.getElementById("m-name").focus();
    }

    function manualAdd() {
        const name = document.getElementById("m-name").value.trim();
        const price = Number(document.getElementById("m-price").value);
        const split = document.getElementById("m-split").value;
        if(!name || !price) return alert("è«‹è¼¸å…¥è³‡æ–™");
        items.push({ name, price, cat: currentManualCat, split });
        saveAndRender();
        document.getElementById("m-name").value = "";
        document.getElementById("m-price").value = "";
        document.getElementById("m-name").focus();
    }

    function handleFile(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById("img-preview").src = e.target.result;
                document.getElementById("img-preview-box").style.display = "block";
                document.getElementById("scan-btn").style.display = "flex";
                document.getElementById("ai-error").style.display = "none";
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // å†ç¸®å°ä¸€é»ä¿å¹³å®‰
                    let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7).split(',')[1]);
                };
            };
        });
    }

    async function processImage() {
        const file = document.getElementById("file-input").files[0];
        const { key, model } = getKeyAndModel();
        const errorEl = document.getElementById("ai-error");
        
        if(!key) return alert("è«‹å…ˆè¨­å®š API Key");

        const btn = document.getElementById("scan-btn");
        btn.disabled = true;
        btn.innerHTML = `<div class="spinner"></div> è¾¨è­˜ä¸­...`;
        errorEl.style.display = "none";

        try {
            const base64 = await compressImage(file);
            const catString = JSON.stringify(CATEGORIES);
            const prompt = `è«‹åˆ†æé€™å¼µæ”¶æ“šã€‚è¦å‰‡ï¼š1.è¾¨è­˜æ‰€æœ‰å“é …(n)å’Œåƒ¹æ ¼(p)ã€‚2.æŠ˜æ‰£è«‹è¦–ç‚ºè² æ•¸ã€‚3.å¾åˆ†é¡(c)é¸æ“‡: ${catString}ã€‚4.å›å‚³ç´”JSON Arrayã€‚`;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }]
                })
            });

            const data = await res.json();
            
            if (data.error) {
                // é¡¯ç¤ºè©³ç´°éŒ¯èª¤
                throw new Error(`API å›å‚³éŒ¯èª¤ (${data.error.code}): ${data.error.message}`);
            }

            if (!data.candidates || !data.candidates[0]) {
                throw new Error(`AI ç„¡æ³•è¾¨è­˜ (Candidates Empty)ã€‚\nåŸå§‹å›æ‡‰: ${JSON.stringify(data)}`);
            }

            let text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
            if (text.startsWith('[') && !text.endsWith(']')) text += ']'; 
            
            const newItems = JSON.parse(text);
            
            newItems.forEach(i => {
                items.push({ name: i.n, price: i.p, cat: i.c || "å…¶ä»–", split: "my_pay_split" });
            });

            saveAndRender();
            alert(`æˆåŠŸï¼æŠ“åˆ° ${newItems.length} ç­†è³‡æ–™ã€‚`);

        } catch (e) {
            console.error(e);
            errorEl.style.display = "block";
            errorEl.innerText = e.message;
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<span id="scan-text">ğŸš€ é–‹å§‹è¾¨è­˜</span>`;
        }
    }

    function saveAndRender() {
        localStorage.setItem("nh_items", JSON.stringify(items));
        renderList();
    }

    function renderList() {
        const div = document.getElementById("items-container");
        div.innerHTML = "";
        let total = 0, ningCost = 0, hsiangCost = 0, hsiangOwes = 0;

        items.forEach((item, idx) => {
            total += item.price;
            const p = item.price;
            switch(item.split) {
                case "my_pay_split": ningCost+=p/2; hsiangCost+=p/2; hsiangOwes+=p/2; break;
                case "his_pay_split": ningCost+=p/2; hsiangCost+=p/2; hsiangOwes-=p/2; break;
                case "his_pay_for_me": ningCost+=p; hsiangOwes-=p; break;
                case "my_pay_for_him": hsiangCost+=p; hsiangOwes+=p; break;
                case "my_pay_my_use": ningCost+=p; break;
                case "his_pay_his_use": hsiangCost+=p; break;
            }

            const row = document.createElement("div");
            row.className = "item-card";
            row.innerHTML = `
                <div class="item-left">
                    <span class="item-title">${item.name}</span>
                    <span class="item-sub">${item.cat}</span>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
                    <span class="item-price">$${item.price}</span>
                    <select onchange="updateSplit(${idx}, this.value)" style="font-size:12px; padding:4px;">
                        ${Object.entries(SPLIT_MAP).map(([k,v]) => `<option value="${k}" ${k===item.split?'selected':''}>${v}</option>`).join('')}
                    </select>
                </div>
                <button onclick="delItem(${idx})" style="background:none; border:none; color:#ef4444; margin-left:10px;"><i class="ph ph-trash"></i></button>
            `;
            div.prepend(row);
        });

        document.getElementById("sum-total").innerText = "$" + Math.round(total);
        const finalDiv = document.getElementById("final-settle");
        const val = Math.round(hsiangOwes);
        if(val > 0) { finalDiv.innerText = `Hsiang çµ¦ Ning $${val}`; finalDiv.style.color = "#10b981"; }
        else if(val < 0) { finalDiv.innerText = `Ning çµ¦ Hsiang $${Math.abs(val)}`; finalDiv.style.color = "#ef4444"; }
        else { finalDiv.innerText = "äº’ä¸ç›¸æ¬ "; finalDiv.style.color = "#f59e0b"; }
    }

    function updateSplit(idx, val) { items[idx].split = val; saveAndRender(); }
    function delItem(idx) { if(confirm("åˆªé™¤ï¼Ÿ")) { items.splice(idx, 1); saveAndRender(); } }

    function copyResult() {
        if(items.length===0) return alert("æ²’è³‡æ–™");
        let summary = {};
        ["his_pay_split", "his_pay_for_me", "his_pay_his_use", "my_pay_split", "my_pay_for_him", "my_pay_my_use"].forEach(k => {
            summary[k] = { text: SPLIT_MAP[k], sum: 0, items: [] };
        });
        items.forEach(i => { if(summary[i.split]) { summary[i.split].sum += i.price; summary[i.split].items.push(i.name); } });
        let text = "";
        Object.values(summary).forEach(d => { if(d.items.length > 0) text += `${d.text}\t${d.sum}\t${d.items.join(", ")}\n`; });
        const ta = document.createElement('textarea'); ta.value = text;
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        alert("âœ… è¤‡è£½æˆåŠŸ");
    }
</script>
</body>
</html>
