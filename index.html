<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ning & Hsiang è¨˜å¸³ (Notionæ‰‹å‹•ç‰ˆ)</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --green: #10b981;
            --yellow: #f59e0b;
            --red: #ef4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0; padding: 20px;
            max-width: 600px; margin: 0 auto;
            line-height: 1.5;
        }
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        h3 { margin-top: 0; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; }
        
        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        input, select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 16px; background: #f9fafb; outline: none;
        }
        input:focus, select:focus { border-color: var(--primary); }

        button {
            width: 100%; padding: 12px; border: none; border-radius: 10px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 6px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid #ddd; color: #666; margin-top: 10px; }
        .btn-danger { background: #fee2e2; color: #ef4444; width: auto; padding: 8px 12px; }

        /* é …ç›®åˆ—è¡¨ */
        .item-row {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .row-top { display: flex; gap: 8px; }
        .row-bottom { display: flex; gap: 8px; }
        
        /* çµç®—å€å¡Š */
        .result-box {
            background: #1f2937;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        .result-row {
            display: flex; justify-content: space-between;
            margin-bottom: 8px; font-size: 0.9em; color: #d1d5db;
        }
        .result-final {
            border-top: 1px solid #374151;
            margin-top: 15px;
            padding-top: 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--yellow);
            text-align: center;
        }

        /* å½™æ•´æ¸…å–®æ¨£å¼ (è®“ä½ å¥½æŠ„å¯«) */
        .summary-list {
            margin-top: 15px;
            border-top: 1px dashed #4b5563;
            padding-top: 15px;
        }
        .summary-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #374151;
        }
        .summary-item:last-child { border-bottom: none; }
        .sum-header { color: #93c5fd; font-weight: bold; display: flex; justify-content: space-between; }
        .sum-items { color: #d1d5db; font-size: 0.9em; margin-top: 4px; line-height: 1.4; }

        .hidden { display: none; }
        
        /* ä¸Šå‚³å€å¡Š */
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: #f8fafc;
        }
        #img-preview { max-width: 100%; border-radius: 8px; margin-top: 15px; display: none; }
        
        /* è¼‰å…¥å‹•ç•« */
        .spinner {
            width: 18px; height: 18px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- API Key è¨­å®š -->
    <div class="card" id="setup-card">
        <h3>ğŸ”‘ è¨­å®š API Key</h3>
        <input type="password" id="api-key" placeholder="è²¼ä¸Š Gemini API Key (AIza...)">
        <button onclick="saveKey()" class="btn-primary" style="margin-top:10px;">å„²å­˜ä¸¦é–‹å§‹</button>
    </div>

    <!-- ä¸Šå‚³å€ -->
    <div class="card">
        <h3>ğŸ“¸ 1. ä¸Šå‚³æ”¶æ“š</h3>
        <label class="upload-area">
            <i class="ph ph-camera" style="font-size: 32px; color: #94a3b8;"></i>
            <div style="color: #64748b; margin-top: 5px;">é»æ­¤æ‹ç…§æˆ–é¸åœ–</div>
            <input type="file" id="file-input" accept="image/*" style="display:none">
        </label>
        <img id="img-preview">
        
        <button onclick="processImage()" class="btn-primary" id="scan-btn" disabled style="margin-top: 15px; opacity: 0.5;">
            <span class="spinner" id="spinner"></span>
            <span id="btn-text">ğŸ¤– AI è¾¨è­˜å“é …</span>
        </button>

        <button onclick="loadDemo()" class="btn-outline" style="font-size: 13px; padding: 8px;">
            ğŸ§ª è¼‰å…¥æ¸¬è©¦è³‡æ–™
        </button>
    </div>

    <!-- ç·¨è¼¯èˆ‡çµç®— -->
    <div id="result-area" class="hidden">
        <div class="card">
            <h3>ğŸ“ 2. ç¢ºèªæ¸…å–®</h3>
            <div id="items-list"></div>
            <button onclick="addNewRow()" class="btn-outline">+ æ–°å¢ä¸€ç­†</button>
        </div>

        <div class="card">
            <h3>ğŸ’° 3. çµç®—é¢æ¿</h3>
            <div class="result-box">
                <!-- åŸºæœ¬æ•¸å­— -->
                <div class="result-row"><span>ç¸½é‡‘é¡</span><span id="sum-total">$0</span></div>
                <div class="result-row"><span>Ning æˆæœ¬</span><span id="sum-my-cost">$0</span></div>
                <div class="result-row"><span>Hsiang æˆæœ¬</span><span id="sum-his-cost">$0</span></div>

                <!-- å½™æ•´é¡¯ç¤ºå€ (æ–°åŠŸèƒ½) -->
                <div class="summary-list" id="visual-summary">
                    <!-- é€™è£¡æœƒé¡¯ç¤ºæ•´ç†å¥½çš„è³‡æ–™çµ¦ä½ çœ‹ -->
                </div>

                <!-- æœ€çµ‚çµç®— -->
                <div class="result-final" id="final-settlement">çµç®—ä¸­...</div>
            </div>

            <button onclick="copyResult()" class="btn-primary" style="background: var(--green); margin-top: 15px;">
                ğŸ“‹ è¤‡è£½ (å½™æ•´æ–‡å­—ç‰ˆ)
            </button>
        </div>
    </div>

<script>
    const CATEGORIES = [
        "ğŸ  å±…ä½", "ğŸ½ï¸ é£²é£Ÿ", "ğŸš— 8510", "ğŸšŒ äº¤é€š", "ğŸ® å¨›æ¨‚", 
        "ğŸ’Š é†«ç™‚", "ğŸ’¸ é›œæ”¯", "âœˆï¸ æ—…éŠ", "ğŸ± å¸•å¸ƒ", "ğŸ“¦ å…¶ä»–"
    ];

    const SPLIT_TYPES = [
        { val: "his_pay_split", text: "Hsiang / 2" },
        { val: "his_pay_for_me", text: "Hsiang å¢Š" },
        { val: "his_pay_his_use", text: "Hsiang" },
        { val: "my_pay_split", text: "Ning / 2" },
        { val: "my_pay_for_him", text: "Ning å¢Š" },
        { val: "my_pay_my_use", text: "Ning" }
    ];

    window.onload = () => {
        const key = localStorage.getItem("gemini_key_v2");
        if(key) {
            document.getElementById("api-key").value = key;
            document.getElementById("setup-card").style.display = "none";
        }
    };

    function saveKey() {
        const key = document.getElementById("api-key").value;
        if(!key) return alert("è«‹è¼¸å…¥ Key");
        localStorage.setItem("gemini_key_v2", key);
        document.getElementById("setup-card").style.display = "none";
        alert("è¨­å®šå®Œæˆï¼");
    }

    document.getElementById("file-input").onchange = (e) => {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById("img-preview").src = e.target.result;
                document.getElementById("img-preview").style.display = "block";
                const btn = document.getElementById("scan-btn");
                btn.disabled = false;
                btn.style.opacity = "1";
            };
            reader.readAsDataURL(file);
        }
    };

    async function processImage() {
        const file = document.getElementById("file-input").files[0];
        const key = localStorage.getItem("gemini_key_v2");
        
        if(!file) return alert("è«‹é¸åœ–ç‰‡");
        if(!key) return alert("è«‹å…ˆè¼¸å…¥ API Key");

        const btn = document.getElementById("scan-btn");
        const spinner = document.getElementById("spinner");
        const btnText = document.getElementById("btn-text");
        
        btn.disabled = true;
        spinner.style.display = "inline-block";
        btnText.innerText = " AI è¾¨è­˜ä¸­...";

        try {
            const base64 = await new Promise(r => {
                const reader = new FileReader();
                reader.onload = () => r(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });

            const catString = JSON.stringify(CATEGORIES);
            
            const prompt = `
            ä½ æ˜¯ä¸€å€‹è¨˜å¸³åŠ©æ‰‹ã€‚è«‹åˆ†æé€™å¼µç™¼ç¥¨/æ”¶æ“šã€‚
            1. æå–æ‰€æœ‰å“é …åç¨± (n) å’Œåƒ¹æ ¼ (p)ã€‚
            2. æ ¹æ“šå“é …åç¨±ï¼Œå¾ä»¥ä¸‹åˆ—è¡¨ä¸­é¸æ“‡ä¸€å€‹æœ€é©åˆçš„åˆ†é¡ (c)ï¼š${catString}ã€‚
            3. å¦‚æœç„¡æ³•ç¢ºå®šï¼Œåˆ†é¡è«‹é¸ "ğŸ“¦ å…¶ä»–"ã€‚
            4. å›å‚³ç´” JSON é™£åˆ—ï¼Œä¸è¦ Markdownã€‚
            `;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: file.type, data: base64 } }] }]
                })
            });

            const data = await res.json();
            let text = data.candidates[0].content.parts[0].text;
            text = text.replace(/```json|```/g, "").trim(); 
            const items = JSON.parse(text);

            renderItems(items);
            document.getElementById("result-area").classList.remove("hidden");
            document.getElementById("result-area").scrollIntoView({behavior: "smooth"});

        } catch(e) {
            alert("è¾¨è­˜å¤±æ•—ï¼š" + e.message);
            console.error(e);
        } finally {
            btn.disabled = false;
            spinner.style.display = "none";
            btnText.innerText = "ğŸ¤– AI è¾¨è­˜å“é …";
        }
    }

    function loadDemo() {
        const demo = [
            {n: "Costco ç‰›è‚‰æ²", p: 89, c: "ğŸ½ï¸ é£²é£Ÿ", type: "my_pay_split"},
            {n: "è›¤è £æ¿ƒæ¹¯", p: 79, c: "ğŸ½ï¸ é£²é£Ÿ", type: "my_pay_split"},
            {n: "å¸•å¸ƒçš„ç½ç½", p: 599, c: "ğŸ± å¸•å¸ƒ", type: "his_pay_split"},
            {n: "Hsiangçš„éŠæˆ²ç‰‡", p: 1200, c: "ğŸ® å¨›æ¨‚", type: "his_pay_his_use"},
            {n: "8510 åŠ æ²¹", p: 1000, c: "ğŸš— 8510", type: "my_pay_for_him"}
        ];
        renderItems(demo);
        document.getElementById("result-area").classList.remove("hidden");
        document.getElementById("result-area").scrollIntoView({behavior: "smooth"});
    }

    function renderItems(items) {
        const list = document.getElementById("items-list");
        list.innerHTML = "";
        items.forEach(i => addItem(i.n, i.p, i.c, i.type || "my_pay_split"));
        calc();
    }

    function addItem(name, price, category = "ğŸ“¦ å…¶ä»–", type = "my_pay_split") {
        const list = document.getElementById("items-list");
        const div = document.createElement("div");
        div.className = "item-row";
        
        div.innerHTML = `
            <div class="row-top">
                <input value="${name}" placeholder="å“é …" style="flex:2">
                <input type="number" value="${price}" oninput="calc()" placeholder="$" style="flex:1; text-align:right">
            </div>
            <div class="row-bottom">
                <select style="flex:1.2" class="cat-select">
                    ${CATEGORIES.map(c => `<option ${c === category ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
                <select style="flex:1.8" onchange="calc()" class="split-select">
                    ${SPLIT_TYPES.map(t => `<option value="${t.val}" ${t.val===type?'selected':''}>${t.text}</option>`).join('')}
                </select>
                <button class="btn-danger" onclick="this.parentElement.parentElement.remove();calc()">
                    <i class="ph ph-trash"></i>
                </button>
            </div>
        `;
        list.appendChild(div);
    }

    function addNewRow() { addItem("", "", "ğŸ“¦ å…¶ä»–"); }

    function calc() {
        let total = 0, ningCost = 0, hsiangCost = 0, hsiangOwesNing = 0;
        
        // å½™æ•´è³‡æ–™çµæ§‹
        let summaryData = {};
        SPLIT_TYPES.forEach(t => summaryData[t.val] = { text: t.text, sum: 0, items: [] });

        document.querySelectorAll(".item-row").forEach(row => {
            const n = row.querySelector("input").value;
            const p = Number(row.querySelector("input[type=number]").value) || 0;
            const splitType = row.querySelector(".split-select").value;

            total += p;

            // ç´¯ç©å½™æ•´è³‡æ–™
            if (n && summaryData[splitType]) {
                summaryData[splitType].sum += p;
                summaryData[splitType].items.push(n);
            }

            // æˆæœ¬è¨ˆç®—
            switch(splitType) {
                case "my_pay_split": 
                    ningCost += p/2; hsiangCost += p/2; hsiangOwesNing += p/2; break;
                case "his_pay_split": 
                    ningCost += p/2; hsiangCost += p/2; hsiangOwesNing -= p/2; break;
                case "his_pay_for_me": 
                    ningCost += p; hsiangOwesNing -= p; break;
                case "my_pay_for_him": 
                    hsiangCost += p; hsiangOwesNing += p; break;
                case "my_pay_my_use": 
                    ningCost += p; break;
                case "his_pay_his_use": 
                    hsiangCost += p; break;
            }
        });

        // é¡¯ç¤ºåŸºæœ¬é‡‘é¡
        document.getElementById("sum-total").innerText = "$" + Math.round(total);
        document.getElementById("sum-my-cost").innerText = "$" + Math.round(ningCost);
        document.getElementById("sum-his-cost").innerText = "$" + Math.round(hsiangCost);

        // é¡¯ç¤ºçµç®—æ–‡å­—
        const finalDiv = document.getElementById("final-settlement");
        const finalVal = Math.round(hsiangOwesNing);
        if (finalVal > 0) {
            finalDiv.innerText = `çµç®—ï¼šHsiang çµ¦ Ning $${finalVal}`;
            finalDiv.style.color = "#4ade80"; 
        } else if (finalVal < 0) {
            finalDiv.innerText = `çµç®—ï¼šNing çµ¦ Hsiang $${Math.abs(finalVal)}`;
            finalDiv.style.color = "#f87171"; 
        } else {
            finalDiv.innerText = "çµç®—ï¼šäº’ä¸ç›¸æ¬ ";
            finalDiv.style.color = "#fbbf24";
        }

        // --- é¡¯ç¤ºè¦–è¦ºåŒ–å½™æ•´ (For Notion æ‰‹å‹•è¼¸å…¥) ---
        const visualDiv = document.getElementById("visual-summary");
        visualDiv.innerHTML = ""; // æ¸…ç©º

        SPLIT_TYPES.forEach(type => {
            const data = summaryData[type.val];
            if (data.items.length > 0) {
                // é€™è£¡ç”¢ç”Ÿæ¯ä¸€è¡Œçš„ HTML
                const itemHTML = `
                    <div class="summary-item">
                        <div class="sum-header">
                            <span>${data.text}</span>
                            <span>$${data.sum}</span>
                        </div>
                        <div class="sum-items">${data.items.join(", ")}</div>
                    </div>
                `;
                visualDiv.innerHTML += itemHTML;
            }
        });
    }

    // --- è¤‡è£½åŠŸèƒ½ (ä¿ç•™ Tab æ ¼å¼çµ¦ Google Sheetsï¼Œä»¥é˜²è¬ä¸€) ---
    function copyResult() {
        let outputText = "";
        let hasData = false;

        // æˆ‘å€‘ç›´æ¥é‡æ–°æŠ“ä¸€æ¬¡ç•«é¢ä¸Šçš„å½™æ•´çµæœä¾†çµ„å­—ä¸²ï¼Œä¿è­‰ä¸€è‡´
        let summaryData = {};
        SPLIT_TYPES.forEach(t => summaryData[t.val] = { text: t.text, sum: 0, items: [] });
        
        document.querySelectorAll(".item-row").forEach(row => {
            const n = row.querySelector("input").value.trim();
            const p = Number(row.querySelector("input[type=number]").value) || 0;
            const splitType = row.querySelector(".split-select").value;
            if(n && summaryData[splitType]) {
                summaryData[splitType].sum += p;
                summaryData[splitType].items.push(n);
                hasData = true;
            }
        });

        if(!hasData) return alert("æ²’æœ‰è³‡æ–™å¯ä»¥è¤‡è£½å–”");

        SPLIT_TYPES.forEach(type => {
            const data = summaryData[type.val];
            if (data.items.length > 0) {
                // æ ¼å¼ï¼šåˆ†é¡ [TAB] ç¸½é‡‘é¡ [TAB] å“é …
                outputText += `${data.text}\t${data.sum}\t${data.items.join(", ")}\n`;
            }
        });

        // åŸ·è¡Œè¤‡è£½
        const textArea = document.createElement('textarea');
        textArea.value = outputText;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            alert("âœ… å·²è¤‡è£½ï¼\n(æ ¼å¼ï¼šåˆ†é¡ ç¸½é¡ å“é …)");
        } catch (err) {
            alert("âŒ è¤‡è£½å¤±æ•—");
        }
        document.body.removeChild(textArea);
    }
</script>
</body>
</html>
